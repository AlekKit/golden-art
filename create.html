<!DOCTYPE html>
<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Create your card</title>
<style>
  :root { color-scheme: light dark; }
  * { box-sizing: border-box; }
  body { margin: 0; background: #eef3f1; font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Arial; }
  header { padding: 28px 16px 8px; max-width: 920px; margin: 0 auto; }
  header h1 { margin: 0; font-size: 28px; }
  main { max-width: 920px; margin: 12px auto 48px; padding: 0 16px; }
  .card { background: #fff; border-radius: 16px; padding: 22px; box-shadow: 0 12px 40px rgba(0,0,0,.08); }
  form { display: grid; gap: 14px; }
  .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
  label { font-size: 13px; opacity: .8; display: block; margin-bottom: 6px; }
  input[type="text"], input[type="email"], input[type="url"] {
    width: 100%; padding: 12px 14px; border: 1px solid #d9dee3; border-radius: 12px; font: inherit; background: #f3f6f8;
  }
  input[type="file"] { display: block; }
  .hint { font-size: 12px; opacity: .7; }
  .actions { display: flex; gap: 12px; align-items: center; margin-top: 6px; }
  button {
    background: #111; color: #fff; border: 0; border-radius: 12px; padding: 12px 16px; cursor: pointer;
  }
  button[disabled] { opacity: .6; cursor: not-allowed; }
  .out { margin-top: 16px; }
  .success, .error {
    background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.08);
  }
  .error { border-left: 4px solid #d63636; }
  .preview {
    display: grid; grid-template-columns: 96px 1fr; gap: 16px; align-items: center; margin-top: 6px;
  }
  .logo-wrap { width: 96px; height: 96px; border-radius: 50%; background: #111; display: grid; place-items: center; overflow: hidden; }
  .logo-wrap img { width: 90px; height: 90px; object-fit: cover; border-radius: 50%; background: #fff; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .small { font-size: 13px; opacity: .8; }
</style>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create Card</title>
  <style>
    :root { color-scheme: light dark; }
    body{margin:0;background:#eef3f1;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Arial}
    main{max-width:920px;margin:28px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 14px}
    .panel{background:#fff;border-radius:16px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,.08)}
    form{display:grid;gap:14px}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:760px){.row{grid-template-columns:1fr}}
    label{font-size:13px;opacity:.8;margin-bottom:6px;display:block}
    input[type=text],input[type=email],input[type=url]{width:100%;padding:12px 14px;border:1px solid #d9dee3;border-radius:12px;background:#f3f6f8}
    input[type=file]{display:block}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{background:#111;color:#fff;border:0;border-radius:12px;padding:12px 16px;cursor:pointer}
    .ok,.err{margin-top:10px;border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .ok{background:#fff}
    .err{background:#fff;border-left:4px solid #d33}
    .preview{display:grid;grid-template-columns:96px 1fr;gap:16px;align-items:center;margin-top:6px}
    .logo{width:96px;height:96px;border-radius:50%;background:#111;display:grid;place-items:center;overflow:hidden}
    .logo img{width:90px;height:90px;border-radius:50%;object-fit:cover;background:#fff}
    .hint{font-size:12px;opacity:.7}
  </style>
</head>
<body>
  <header><h1>Create your card</h1></header>
<main>
    <div class="card">
      <form id="cardForm" novalidate>
    <h1>Create your card</h1>
    <div class="panel">
      <form id="createForm">
<div class="row">
          <div>
            <label>Full name</label>
            <input name="name" type="text" required placeholder="Ivica Jakimovski" />
          </div>
          <div>
            <label>Job title</label>
            <input name="title" type="text" placeholder="Generalen Direktor" />
          </div>
          <div><label for="name">Full name</label><input id="name" type="text" placeholder="Ivica Jakimovski" required></div>
          <div><label for="title">Job title</label><input id="title" type="text" placeholder="Generalen Direktor"></div>
</div>

<div class="row">
          <div>
            <label>Company</label>
            <input name="company" type="text" placeholder="Golden Art" />
          </div>
          <div>
            <label>Phone (intl)</label>
            <input name="phone" type="text" required placeholder="+389 70 369 666" />
          </div>
          <div><label for="company">Company</label><input id="company" type="text" placeholder="Golden Art"></div>
          <div><label for="phone">Phone</label><input id="phone" type="text" placeholder="+389 70 369 666"></div>
</div>

<div class="row">
          <div>
            <label>Email</label>
            <input name="email" type="email" required placeholder="ivica@goldenart.mk" />
          </div>
          <div>
            <label>Website</label>
            <input name="website" type="url" placeholder="https://goldenart.mk" />
          </div>
          <div><label for="email">Email</label><input id="email" type="email" placeholder="ivica@goldenart.mk"></div>
          <div><label for="website">Website</label><input id="website" type="url" placeholder="https://goldenart.mk"></div>
</div>

<div>
          <label>Work address</label>
          <input name="address" type="text" placeholder="Street, City, Region, Postal, Country" />
          <label for="address">Work address</label>
          <input id="address" type="text" placeholder="РУДИ ЧАЈАВЕЦ 7-2/д.п.3, СКОПЈЕ - АЕРОДРОМ, Северна Македонија">
</div>

<div>
          <label>Logo (image)</label>
          <input id="logo" type="file" accept="image/*" />
          <div class="hint">Optional. We compress it before upload.</div>
          <div id="preview" class="preview" style="display:none;">
            <div class="logo-wrap"><img id="previewImg" alt="logo preview" /></div>
            <div class="small" id="previewInfo"></div>
          <label for="logoInput">Logo (JPEG under 1MB)</label>
          <input id="logoInput" type="file" accept="image/*">
          <div id="previewWrap" class="preview" style="display:none">
            <div class="logo"><img id="previewImg" alt=""></div>
            <div class="hint" id="previewHint"></div>
</div>
</div>

<div class="actions">
          <button id="btn" type="submit">Generate</button>
          <span class="hint">You’ll get a link like <span class="mono">/card/your-name-1234</span></span>
          <button type="submit">Generate</button>
</div>
      </form>

      <div id="out" class="out"></div>
        <div id="msg"></div>
      </form>
</div>
</main>

<script>
/* ===== Helpers ===== */
function normalizePhone(v) {
  if (!v) return "";
  return v.replace(/[^\d+]/g, "");
}
function dataUrlFromFile(file, max = 900, quality = 0.9) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const fr = new FileReader();
    fr.onload = () => (img.src = fr.result);
    fr.onerror = reject;
    img.onload = () => {
      const ratio = Math.min(1, max / Math.max(img.width, img.height));
      const w = Math.round(img.width * ratio), h = Math.round(img.height * ratio);
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const ctx = c.getContext("2d");
      ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);
      resolve(c.toDataURL("image/jpeg", quality));
    };
    img.onerror = reject;
    fr.readAsDataURL(file);
  });
}
  <script>
    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const normalizePhone = v => (v||'').replace(/[^\d+]/g,'');

    async function compressToBase64(file, maxSide = 900, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const img = new Image(), fr = new FileReader();
        fr.onload = () => img.src = fr.result;
        fr.onerror = reject;
        img.onload = () => {
          const s = Math.min(1, maxSide / Math.max(img.width, img.height));
          const w = Math.round(img.width * s), h = Math.round(img.height * s);
          const c = document.createElement('canvas'); c.width = w; c.height = h;
          const ctx = c.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
          ctx.drawImage(img, 0, 0, w, h);
          const dataUrl = c.toDataURL('image/jpeg', quality);
          const base64  = dataUrl.split(',')[1]; // send ONLY base64 to backend
          resolve({ base64, approxBytes: Math.floor(base64.length * 0.75), dataUrl });
        };
        img.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

/* ===== UI wiring ===== */
const logoInput = document.getElementById("logo");
const preview = document.getElementById("preview");
const previewImg = document.getElementById("previewImg");
const previewInfo = document.getElementById("previewInfo");
let logoDataUrl = null;
    let lastBase64 = null;

logoInput.addEventListener("change", async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) {
    preview.style.display = "none";
    logoDataUrl = null;
    return;
  }
  const beforeKB = Math.round(file.size / 1024);
  logoDataUrl = await dataUrlFromFile(file);
  const afterKB = Math.round((logoDataUrl.length * 0.75) / 1024); // estimate
  previewImg.src = logoDataUrl;
  previewInfo.textContent = `Compressed ${beforeKB} KB → ~${afterKB} KB`;
  preview.style.display = "grid";
});
    // live preview + compression
    $('#logoInput').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) { $('#previewWrap').style.display = 'none'; lastBase64 = null; return; }
      const beforeKB = Math.round(f.size/1024);
      const { base64, approxBytes, dataUrl } = await compressToBase64(f, 900, 0.85);
      lastBase64 = base64;
      const afterKB = Math.round(approxBytes/1024);
      $('#previewImg').src = dataUrl;
      $('#previewHint').textContent = `Compressed ${beforeKB} KB → ~${afterKB} KB (JPEG)`;
      $('#previewWrap').style.display = 'grid';
      if (approxBytes > 1_000_000) {
        alert('Logo still too big after compression. Please choose a smaller image.');
        $('#logoInput').value = '';
        lastBase64 = null;
        $('#previewWrap').style.display = 'none';
      }
    });

document.getElementById("cardForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const btn = document.getElementById("btn");
  const out = document.getElementById("out");
  out.innerHTML = "";
    // submit
    $('#createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = $('#msg'); msg.className=''; msg.textContent='';

  const fd = new FormData(e.target);
  const payload = {
    name: (fd.get("name") || "").trim(),
    title: (fd.get("title") || "").trim(),
    company: (fd.get("company") || "").trim(),
    phone: normalizePhone(fd.get("phone") || ""),
    email: (fd.get("email") || "").trim(),
    website: (fd.get("website") || "").trim(),
    address: (fd.get("address") || "").trim(),
    logoDataUrl: logoDataUrl || undefined
  };
      const payload = {
        name:    $('#name').value.trim(),
        title:   $('#title').value.trim(),
        company: $('#company').value.trim(),
        phone:   normalizePhone($('#phone').value.trim()),
        email:   $('#email').value.trim(),
        website: $('#website').value.trim(),
        address: $('#address').value.trim(),
        logo_base64: lastBase64 || null
      };

  if (!payload.name || (!payload.phone && !payload.email)) {
    out.innerHTML = '<div class="error">Please enter a name and at least a phone or email.</div>';
    return;
  }
      if (!payload.name || (!payload.phone && !payload.email)) {
        msg.className='err'; msg.textContent='Enter a name and at least a phone or email.'; return;
      }

  btn.disabled = true; btn.textContent = "Generating…";
  try {
    const res = await fetch("/.netlify/functions/create_profile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.message || json.error || ("HTTP "+res.status));
      try {
        const res = await fetch('/.netlify/functions/create_profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const out = await res.json();

    const url = location.origin + json.card_url;
    out.innerHTML = `
      <div class="success">
        <strong>Your card is ready!</strong><br>
        <a href="${json.card_url}" target="_blank">${url}</a><br>
        vCard endpoint: <span class="mono">${json.vcf_url}</span>
      </div>`;
  } catch (err) {
    out.innerHTML = `<div class="error">Error: ${err.message}</div>`;
  } finally {
    btn.disabled = false; btn.textContent = "Generate";
  }
});
</script>
        if (!out.ok || !out.slug) {
          msg.className='err'; msg.textContent = out.error || 'Failed to create profile';
          return;
        }

        const cardPath = out.card_url || `/card/${out.slug}`;
        const vcfPath  = out.vcf_url  || `/.netlify/functions/vcf?slug=${out.slug}`;
        msg.className='ok';
        msg.innerHTML = `
          <strong>Your card is ready!</strong><br>
          <a href="${cardPath}" target="_blank">${location.origin + cardPath}</a><br>
          vCard endpoint: <a href="${vcfPath}" target="_blank">${location.origin + vcfPath}</a>
        `;
      } catch (err) {
        msg.className='err'; msg.textContent = String(err?.message || err);
      }
    });
  </script>
</body>
</html>
