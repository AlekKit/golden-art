<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create Card</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg1:#e8f0ec; --bg2:#f6faf8;
      --panel:#ffffff; --panel-br:#d9dee3;
      --text:#0f1720; --muted:#66737e;
      --input-bg:#f3f6f8; --input-br:#d9dee3;
      --accent:#0ea5e9;
      --shadow:0 18px 60px rgba(0,0,0,.10);
      --shadow-sm:0 10px 30px rgba(0,0,0,.08);
      --btn:#111; --btnText:#fff;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg1:#0b1014; --bg2:#0f171c;
        --panel:#12181d; --panel-br:#26323b;
        --text:#eef3f1; --muted:#a7b2bb;
        --input-bg:#0f151a; --input-br:#26323b;
        --accent:#38bdf8;
        --shadow:0 18px 60px rgba(0,0,0,.55);
        --shadow-sm:0 10px 30px rgba(0,0,0,.35);
        --btn:#e9e9e9; --btnText:#0b0b0b;
      }
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at -10% -10%, var(--bg2), transparent 60%),
        radial-gradient(1000px 600px at 110% 0%, var(--bg2), transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100dvh;
    }

    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .titleRow{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 16px var(--accent)}
    h1{font-size:28px;margin:0}
    .backLink{
      text-decoration:none;font-weight:600;font-size:14px;
      background:transparent;color:var(--text);
      border:1px solid var(--panel-br); padding:8px 12px; border-radius:10px;
      box-shadow:var(--shadow-sm); transition:transform .06s ease,opacity .15s ease;
    }
    .backLink:hover{transform:translateY(-1px);opacity:.95}

    .panel{
      background:var(--panel);
      border:1px solid var(--panel-br);
      border-radius:18px;
      padding:20px;
      box-shadow:var(--shadow);
    }

    form{display:grid;gap:16px}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:760px){.row{grid-template-columns:1fr}}

    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}

    /* Field with icon */
    .field{position:relative}
    .field input[type=text],
    .field input[type=email],
    .field input[type=url],
    .field input[type=tel]{
      width:100%;
      padding:12px 14px 12px 46px; /* icon room */
      border:1px solid var(--input-br);
      border-radius:12px;
      background:var(--input-bg);
      color:inherit; outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .field input:focus{border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in srgb, var(--accent) 22%, transparent)}
    .field svg{
      position:absolute; left:14px; top:50%; transform:translateY(-50%);
      width:18px; height:18px; opacity:.6; pointer-events:none;
    }

    input[type=file]{display:block}

    .preview{display:grid;grid-template-columns:96px 1fr;gap:16px;align-items:center;margin-top:6px}
    .logo{width:96px;height:96px;border-radius:50%;background:#111;display:grid;place-items:center;overflow:hidden;box-shadow:var(--shadow-sm)}
    .logo img{width:90px;height:90px;border-radius:50%;object-fit:cover;background:#fff}
    .hint{font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      background:var(--btn);color:var(--btnText);border:0;border-radius:12px;
      padding:12px 16px;cursor:pointer;box-shadow:var(--shadow-sm);
      transition:transform .06s ease,opacity .15s ease;
    }
    button:hover{transform:translateY(-1px);opacity:.96}
    button[disabled]{opacity:.6;cursor:not-allowed}

    .ok,.err{margin-top:10px;border-radius:12px;padding:12px;box-shadow:var(--shadow-sm);background:var(--panel)}
    .err{border-left:4px solid #d33}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleRow">
        <span class="dot"></span>
        <h1>Create your card</h1>
      </div>
      <a class="backLink" href="/">← Back to homepage</a>
    </header>

    <div class="panel">
      <form id="createForm">
        <div class="row">
          <div>
            <label for="name">Full name</label>
            <div class="field">
              <!-- user icon -->
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
              <input id="name" type="text" placeholder="Full name" required>
            </div>
          </div>
          <div>
            <label for="title">Job title</label>
            <div class="field">
              <!-- briefcase -->
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M20 6h-4V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2H4a2 2 0 0 0-2 2v2h20V8a2 2 0 0 0-2-2ZM8 4h8v2H8Z"/><path d="M22 12H2v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2Z"/></svg>
              <input id="title" type="text" placeholder="Job title">
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="company">Company</label>
            <div class="field">
              <!-- building -->
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 21V3h8v4h10v14H3Zm2-2h6V5H5v14Zm8 0h6V9h-6v10Z"/></svg>
              <input id="company" type="text" placeholder="Company">
            </div>
          </div>
          <div>
            <label for="phone">Phone</label>
            <div class="field">
              <!-- phone -->
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M6.62 10.79a15.46 15.46 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 .91-.27c1 .23 2.07.35 3.18.35a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1C10.07 21 3 13.93 3 5a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.11.12 2.18.35 3.18a1 1 0 0 1-.27.91l-2.2 2.2Z"/></svg>
              <input id="phone" type="text" placeholder="+389 70 000 000">
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="email">Email</label>
            <div class="field">
              <!-- mail -->
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2ZM4 8l8 5 8-5V6l-8 5L4 6Z"/></svg>
              <input id="email" type="email" placeholder="name@company.com">
            </div>
          </div>
          <div>
            <label for="website">Website</label>
            <div class="field">
              <!-- globe -->
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm5 10a8 8 0 0 1-8 8c0-4.42 3.58-8 8-8Zm-5-8a8 8 0 0 1 8 8h-8Z"/></svg>
              <input id="website" type="url" placeholder="https://yourwebsite.com">
            </div>
          </div>
        </div>

        <div>
          <label for="address">Work address</label>
          <div class="field">
            <!-- pin -->
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7Zm0 9.5A2.5 2.5 0 1 1 14.5 9 2.5 2.5 0 0 1 12 11.5Z"/></svg>
            <input id="address" type="text" placeholder="Street, City, Region, Postal, Country">
          </div>
        </div>

        <div>
          <label for="logoInput">Logo (JPEG under 1MB)</label>
          <input id="logoInput" type="file" accept="image/*">
          <div id="previewWrap" class="preview" style="display:none">
            <div class="logo"><img id="previewImg" alt=""></div>
            <div class="hint" id="previewHint"></div>
          </div>
        </div>

        <div class="actions">
          <button type="submit">Generate</button>
        </div>

        <div id="msg"></div>
      </form>
    </div>
  </div>

  <!-- Functionality preserved exactly -->
  <script>
    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const normalizePhone = v => (v||'').replace(/[^\d+]/g,'');

    async function compressToBase64(file, maxSide = 900, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const img = new Image(), fr = new FileReader();
        fr.onload = () => img.src = fr.result;
        fr.onerror = reject;
        img.onload = () => {
          const s = Math.min(1, maxSide / Math.max(img.width, img.height));
          const w = Math.round(img.width * s), h = Math.round(img.height * s);
          const c = document.createElement('canvas'); c.width = w; c.height = h;
          const ctx = c.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
          ctx.drawImage(img, 0, 0, w, h);
          const dataUrl = c.toDataURL('image/jpeg', quality);
          const base64  = dataUrl.split(',')[1]; // send ONLY base64 to backend
          resolve({ base64, approxBytes: Math.floor(base64.length * 0.75), dataUrl });
        };
        img.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    let lastBase64 = null;

    // live preview + compression
    $('#logoInput').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) { $('#previewWrap').style.display = 'none'; lastBase64 = null; return; }
      const beforeKB = Math.round(f.size/1024);
      const { base64, approxBytes, dataUrl } = await compressToBase64(f, 900, 0.85);
      lastBase64 = base64;
      const afterKB = Math.round(approxBytes/1024);
      $('#previewImg').src = dataUrl;
      $('#previewHint').textContent = `Compressed ${beforeKB} KB → ~${afterKB} KB (JPEG)`;
      $('#previewWrap').style.display = 'grid';
      if (approxBytes > 1_000_000) {
        alert('Logo still too big after compression. Please choose a smaller image.');
        $('#logoInput').value = '';
        lastBase64 = null;
        $('#previewWrap').style.display = 'none';
      }
    });

    // submit (unchanged payload/flow; hides vCard endpoint in success)
    $('#createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = $('#msg'); msg.className=''; msg.textContent='';

      const payload = {
        name:    $('#name').value.trim(),
        title:   $('#title').value.trim(),
        company: $('#company').value.trim(),
        phone:   normalizePhone($('#phone').value.trim()),
        email:   $('#email').value.trim(),
        website: $('#website').value.trim(),
        address: $('#address').value.trim(),
        logo_base64: lastBase64 || null
      };

      if (!payload.name || (!payload.phone && !payload.email)) {
        msg.className='err'; msg.textContent='Enter a name and at least a phone or email.'; return;
      }

      try {
        const res = await fetch('/.netlify/functions/create_profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const out = await res.json();

        if (!out.ok || !out.slug) {
          msg.className='err'; msg.textContent = out.error || 'Failed to create profile';
          return;
        }

        const cardPath = out.card_url || `/card/${out.slug}`;
        msg.className='ok';
        msg.innerHTML = `
          <strong>Your card is ready!</strong><br>
          <a href="${cardPath}" target="_blank">${location.origin + cardPath}</a>
        `;
        /* vCard endpoint intentionally hidden:
           const vcfPath = out.vcf_url || '/.netlify/functions/vcf?slug='+out.slug;
        */
      } catch (err) {
        msg.className='err'; msg.textContent = String(err?.message || err);
      }
    });
  </script>
</body>
</html>
