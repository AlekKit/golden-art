<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Create your card</title>
<style>
  :root{
    --bg1:#e8f0ec; --bg2:#f6faf8;
    --panel:#ffffff; --panel-border:rgba(15,23,32,.08);
    --text:#0f1720; --muted:#66737e;
    --input-bg:#f7fafb; --input-br:#d8e0e6;
    --ring:#1f2937;
    --btn:#111111; --btnText:#ffffff; --btnBorder:transparent;
    --secondaryBorder:#dde5ea;
    --shadow:0 30px 80px rgba(0,0,0,.14);
    --shadow-sm:0 10px 30px rgba(0,0,0,.08);
    --accent:#0ea5e9;
    --ok:#10b981; --err:#ef4444;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg1:#0b1014; --bg2:#0f171c;
      --panel:#12181d; --panel-border:rgba(255,255,255,.06);
      --text:#eef3f1; --muted:#a7b2bb;
      --input-bg:#0f151a; --input-br:#26323b;
      --ring:#7dd3fc;
      --btn:#e9e9e9; --btnText:#0b0b0b; --btnBorder:#e9e9e9;
      --secondaryBorder:#2b3943;
      --shadow:0 30px 80px rgba(0,0,0,.5);
      --shadow-sm:0 10px 30px rgba(0,0,0,.35);
      --accent:#38bdf8;
    }
  }

  *{box-sizing:border-box}
  body{
    margin:0; min-height:100dvh;
    font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Arial;
    color:var(--text);
    background:
      radial-gradient(1000px 500px at 10% -10%, var(--bg2), transparent 60%),
      radial-gradient(900px 500px at 110% 0%, var(--bg2), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
  }

  .wrap{max-width:980px;margin:36px auto;padding:0 20px}
  header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 18px}
  .logoWrap{display:flex;align-items:center;gap:12px}
  .logoDot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
  h1{margin:0;font-size:32px;letter-spacing:.2px}
  .backLink{
    font-size:14px; font-weight:500; text-decoration:none;
    background:var(--panel); border:1px solid var(--secondaryBorder);
    padding:8px 14px; border-radius:10px;
    color:var(--text);
    box-shadow:var(--shadow-sm);
    transition:background .15s ease, transform .06s ease;
  }
  .backLink:hover{background:var(--input-bg); transform:translateY(-1px)}

  .card{
    background:var(--panel);
    border:1px solid var(--panel-border);
    border-radius:22px;
    box-shadow:var(--shadow);
    padding:26px 24px;
    backdrop-filter:saturate(120%) blur(2px);
  }

  form{display:grid;gap:18px}
  .grid-2{display:grid;gap:18px;grid-template-columns:1fr 1fr}
  @media (max-width:820px){.grid-2{grid-template-columns:1fr}}

  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
  .field{position:relative}

  .field input[type=text],
  .field input[type=email],
  .field input[type=url],
  .field input[type=tel]{
    width:100%;
    padding:14px 16px 14px 46px;
    border:1px solid var(--input-br);
    background:var(--input-bg);
    border-radius:14px;
    color:var(--text);
    outline:none;
    transition:border-color .15s ease, box-shadow .15s ease, transform .04s ease;
  }
  .field input:focus{
    border-color:var(--ring);
    box-shadow:0 0 0 3px color-mix(in srgb, var(--ring) 22%, transparent);
  }

  .fileRow{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .fileRow input[type=file]{display:none}
  .btn-file{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--btn); color:var(--btnText);
    border:1px solid var(--btnBorder);
    border-radius:12px;padding:10px 14px;cursor:pointer;
    box-shadow:var(--shadow-sm); transition:transform .06s ease, opacity .15s ease;
  }
  .btn-file:hover{transform:translateY(-1px);opacity:.95}
  .hint{font-size:12px;color:var(--muted)}
  .preview{width:64px;height:64px;border-radius:50%;overflow:hidden;background:#111;display:grid;place-items:center;box-shadow:var(--shadow-sm)}
  .preview img{width:100%;height:100%;object-fit:cover}

  .actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:4px}
  .btn{
    background:var(--btn); color:var(--btnText);
    border:1px solid var(--btnBorder);
    border-radius:14px; padding:12px 18px; font-weight:600; cursor:pointer;
    box-shadow:var(--shadow-sm); transition:transform .06s ease, opacity .15s ease;
  }
  .btn:hover{transform:translateY(-1px);opacity:.96}
  .note{font-size:13px;color:var(--muted)}
  .msg{font-size:13px;margin-top:6px}
  .err{color:var(--err)} .ok{color:var(--ok)}

  #result{
    margin-top:12px; font-size:14px; word-break:break-word;
    background:var(--input-bg); border:1px dashed var(--input-br);
    border-radius:14px; padding:12px 14px;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logoWrap">
        <span class="logoDot"></span>
        <h1>Create your card</h1>
      </div>
      <a class="backLink" href="/">← Back to homepage</a>
    </header>

    <div class="card">
      <form id="createForm" onsubmit="return false;">
        <div class="grid-2">
          <div>
            <label for="name">Full name</label>
            <div class="field">
              <input id="name" type="text" placeholder="Enter full name" required/>
            </div>
          </div>
          <div>
            <label for="title">Job title</label>
            <div class="field">
              <input id="title" type="text" placeholder="Enter job title"/>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="company">Company</label>
            <div class="field">
              <input id="company" type="text" placeholder="Enter company"/>
            </div>
          </div>
          <div>
            <label for="phone">Mobile phone</label>
            <div class="field">
              <input id="phone" type="tel" placeholder="+389 70 123 456"/>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="email">Email</label>
            <div class="field">
              <input id="email" type="email" placeholder="name@company.com"/>
            </div>
          </div>
          <div>
            <label for="website">Website</label>
            <div class="field">
              <input id="website" type="url" placeholder="https://company.com"/>
            </div>
          </div>
        </div>

        <div>
          <label for="address">Address</label>
          <div class="field">
            <input id="address" type="text" placeholder="Street, City, Country"/>
          </div>
        </div>

        <div>
          <label>Logo / photo <span style="color:var(--muted)">(required)</span></label>
          <div class="fileRow">
            <label class="btn-file">
              <input id="logo" type="file" accept="image/*"/>
              Choose file
            </label>
            <div class="preview" aria-hidden="true"><img id="preview" alt=""></div>
            <div class="hint">We’ll optimize and save it as JPEG.</div>
          </div>
          <div id="imgMsg" class="msg"></div>
        </div>

        <div class="actions">
          <button id="generateBtn" class="btn" type="button">Generate</button>
          <span class="note">After generating, you’ll get the card URL below.</span>
        </div>

        <div id="result"></div>
      </form>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const fileInput = el('logo');
    const previewImg = el('preview');
    const imgMsg = el('imgMsg');
    const resultBox = el('result');
    const btn = el('generateBtn');

    let image_base64 = null; // raw base64 (no prefix)
    let image_mime = 'image/jpeg'; // we normalize to JPEG

    // Read, normalize to JPEG, compress, and set preview + base64
    async function readAndNormalizeToJpeg(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('Failed to read image'));
        reader.onload = () => {
          const dataUrl = reader.result; // full data URL
          const img = new Image();
          img.onerror = () => reject(new Error('Invalid image'));
          img.onload = () => {
            // draw to canvas and export as JPEG
            const canvas = document.createElement('canvas');
            const maxSide = 1200;
            const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
            canvas.width = Math.round(img.width * scale);
            canvas.height = Math.round(img.height * scale);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            let q = 0.88;
            let jpegUrl = canvas.toDataURL('image/jpeg', q);
            const target = 500 * 1024; // ~500KB max
            while (jpegUrl.length > target && q > 0.6) {
              q -= 0.06;
              jpegUrl = canvas.toDataURL('image/jpeg', q);
            }

            // preview (full data URL)
            previewImg.src = jpegUrl;

            // strip prefix -> raw base64 only
            const b64 = jpegUrl.split(',')[1] || null;
            resolve({ base64: b64, mime: 'image/jpeg', preview: jpegUrl });
          };
          img.src = dataUrl;
        };
        reader.readAsDataURL(file);
      });
    }

    fileInput?.addEventListener('change', async () => {
      imgMsg.textContent = '';
      image_base64 = null;

      const f = fileInput.files?.[0];
      if (!f) {
        previewImg.removeAttribute('src');
        return;
      }
      try {
        const { base64, mime, preview } = await readAndNormalizeToJpeg(f);
        if (!base64) throw new Error('Could not encode image');
        image_base64 = base64;
        image_mime = mime;
        previewImg.src = preview;

        // basic feedback
        const approxKB = Math.round((base64.length * 3 / 4) / 1024);
        imgMsg.innerHTML = `<span class="ok">Image ready (~${approxKB} KB, JPEG)</span>`;
        console.log('[create] image_mime:', image_mime, 'base64_length:', base64.length);
      } catch(err){
        imgMsg.innerHTML = `<span class="err">${err.message}</span>`;
      }
    });

    function slugify(name){
      return (name || 'card')
        .toLowerCase().trim()
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'')
        .slice(0,50) + '-' + Math.random().toString(36).slice(2,6);
    }

    function setBusy(b){ btn.disabled=b; btn.textContent=b?'Generating…':'Generate'; }
    function showError(msg){ resultBox.innerHTML = `<div class="msg err">❌ ${msg}</div>`; }
    function showSuccess(url){ resultBox.innerHTML = `<div class="msg ok">✅ Your card is ready!<br><a href="${url}">${url}</a></div>`; }

    btn.addEventListener('click', async () => {
      resultBox.textContent = '';

      const name = el('name').value.trim();
      const title = el('title').value.trim();
      const company = el('company').value.trim();
      const phone = el('phone').value.trim();
      const email = el('email').value.trim();
      const website = el('website').value.trim();
      const address = el('address').value.trim();

      if (!name) { showError('Please enter a name.'); return; }
      if (!phone && !email) { showError('Enter at least a phone or an email.'); return; }
      if (!image_base64) { showError('Please select an image before generating.'); return; }

      const payload = {
        name, title, company, phone, email, website, address,
        slug: slugify(name),
        image_base64,            // raw base64 string (no data: prefix)
        image_mime               // always "image/jpeg" here
      };

      console.log('[create] sending payload sizes:', {
        base64_len: image_base64?.length || 0,
        name_len: name.length
      });

      setBusy(true);
      try {
        const res = await fetch('/.netlify/functions/create_profile', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          throw new Error(`Server error (${res.status}): ${t || 'failed to create profile'}`);
        }

        const data = await res.json();
        const slug = data.slug || payload.slug;
        showSuccess(`${location.origin}/card/${slug}`);
      } catch (e) {
        showError(e.message || 'Failed to create profile.');
      } finally {
        setBusy(false);
      }
    });
  </script>
</body>
</html>
