<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin – Card Manager</title>
<style>
  /* ---------- Force light theme (no auto-invert in dark mode) ---------- */
  *{box-sizing:border-box}
  body{
    margin:0;
    background:#eef3f1;     /* light background */
    color:#111;             /* dark text */
    font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Arial;
  }
  a{color:#111;text-decoration:none}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}

  /* Shared cards/inputs always white with dark text */
  .card, .table, input, textarea { background:#fff; color:#111; }
  .muted{ color:#555; }

  /* Buttons */
  .btn{background:#111;color:#fff;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.secondary{background:#2f2f2f}
  .btn.danger{background:#b21d1d}
  .btn.ghost{background:transparent;color:#111;border:1px solid #d9dee3}

  /* Login */
  .login-wrap{max-width:420px;margin:16vh auto}
  .card{border-radius:16px;box-shadow:0 16px 50px rgba(0,0,0,.1);padding:20px}
  .title{font-size:24px;font-weight:700;margin:8px 0 14px}
  label{font-size:13px;opacity:.8}
  input[type=text],input[type=password],input[type=email],input[type=url]{
    width:100%;padding:12px 14px;border:1px solid #d9dee3;border-radius:12px;background:#f3f6f8
  }
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media(max-width:760px){.row{grid-template-columns:1fr}}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .toolbar input{max-width:260px}

  /* Dashboard layout */
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  .table{width:100%;border-collapse:collapse;border-radius:16px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,.08)}
  th,td{padding:12px 14px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  thead th{background:#f7f9fb;font-weight:600}
  tbody tr:hover{background:#fafbfd}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef3f1;font-size:12px}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{background:#fff;color:#111;border-radius:16px;box-shadow:0 20px 70px rgba(0,0,0,.2);max-width:760px;width:100%;padding:16px}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .modal h3{margin:0}
  .form{display:grid;gap:12px}
  .form .row3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
  @media(max-width:900px){.form .row3{grid-template-columns:1fr}}
  textarea{width:100%;padding:12px 14px;border:1px solid #d9dee3;border-radius:12px;background:#f3f6f8;min-height:70px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .right{margin-left:auto}
  .preview{display:flex;gap:14px;align-items:center}
  .avatar{width:90px;height:90px;border-radius:50%;background:#111;display:grid;place-items:center;overflow:hidden}
  .avatar img{width:84px;height:84px;object-fit:cover;border-radius:50%;background:#fff}

  /* Toast */
  .toast{position:fixed;bottom:20px;right:20px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;z-index:60}
  .toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginView" class="login-wrap">
  <div class="card">
    <div class="title">Admin login</div>
    <div class="form" id="loginForm">
      <div>
        <label>Admin key</label>
        <input id="adminKey" type="password" placeholder="Enter admin key" autofocus />
      </div>
      <div class="actions">
        <button class="btn" id="loginBtn">Sign in</button>
        <label class="muted"><input id="remember" type="checkbox" checked /> Remember on this device</label>
      </div>
      <div id="loginMsg" class="muted"></div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="appView" class="container" style="display:none">
  <div class="grid">
    <div class="card">
      <div class="toolbar">
        <div class="title" style="margin:0">Cards</div>
        <input id="q" type="text" placeholder="Search name/company/email/phone"/>
        <button class="btn" id="searchBtn">Search</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
        <div class="right"></div>
        <button class="btn secondary" id="refreshBtn">Refresh</button>
        <button class="btn" id="newBtn">Create new</button>
        <button class="btn ghost" id="logoutBtn">Logout</button>
      </div>
    </div>

    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Name</th>
          <th>Company</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Links</th>
          <th style="width:210px">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="card" style="display:flex;gap:10px;align-items:center">
      <button class="btn" id="prevBtn">Prev</button>
      <button class="btn" id="nextBtn">Next</button>
      <span id="status" class="muted"></span>
    </div>
  </div>
</div>

<!-- MODAL: CREATE / EDIT -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">Edit profile</h3>
      <button class="btn ghost" id="closeModal">Close</button>
    </div>
    <form id="f" class="form">
      <input type="hidden" id="slug" />
      <div class="row">
        <div><label>Full name</label><input id="name" required></div>
        <div><label>Job title</label><input id="title"></div>
      </div>
      <div class="row">
        <div><label>Company</label><input id="company"></div>
        <div><label>Phone</label><input id="phone" placeholder="+38970369666"></div>
      </div>
      <div class="row">
        <div><label>Email</label><input id="email" type="email"></div>
        <div><label>Website</label><input id="website" type="url" placeholder="https://..."></div>
      </div>
      <div><label>Address</label><input id="address"></div>

      <div class="row">
        <div>
          <label>Logo (JPEG &lt; 1MB)</label>
          <input id="logo" type="file" accept="image/*">
          <div class="preview" style="margin-top:6px">
            <div class="avatar"><img id="preview" alt=""></div>
            <div class="muted" id="previewHint">No image</div>
          </div>
        </div>
        <div></div>
      </div>

      <div class="actions">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn danger" id="deleteBtn" type="button">Delete</button>
        <div class="right muted" id="msg"></div>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ------------ Utilities ------------ */
const $ = s => document.querySelector(s);
const API = {
  list:  (q,offset=0,limit=20)=> fetch(`/.netlify/functions/list_profiles?q=${encodeURIComponent(q||'')}&offset=${offset}&limit=${limit}`, { headers: authHeaders() }).then(h),
  get:   (slug)=> fetch(`/.netlify/functions/get_profile?slug=${encodeURIComponent(slug)}`).then(h),
  create:(payload)=> fetch('/.netlify/functions/create_profile',{ method:'POST', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify(payload)}).then(h),
  update:(slug,payload)=> fetch(`/.netlify/functions/update_profile?slug=${encodeURIComponent(slug)}`, { method:'PUT', headers:{ ...authHeaders(), 'Content-Type':'application/json' }, body: JSON.stringify(payload)}).then(h),
  del:   (slug)=> fetch(`/.netlify/functions/delete_profile?slug=${encodeURIComponent(slug)}`, { method:'DELETE', headers: authHeaders() }).then(h),
};
function h(r){ if(!r.ok) return r.text().then(t=>{throw new Error(t||r.status) }); return r.json(); }
function authHeaders(){ const k=localStorage.getItem('ADMIN_KEY')||''; return { 'x-admin-key': k }; }
function toast(t){ const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }
function normalizePhone(v){ return (v||'').replace(/[^\d+]/g,''); }

/* image compression -> base64 only */
async function compressToBase64(file, maxSide=900, quality=0.85){
  return new Promise((resolve, reject)=>{
    const img=new Image(), fr=new FileReader();
    fr.onload=()=>img.src=fr.result; fr.onerror=reject;
    img.onload=()=>{
      const s=Math.min(1,maxSide/Math.max(img.width,img.height));
      const w=Math.round(img.width*s), h=Math.round(img.height*s);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
      ctx.drawImage(img,0,0,w,h);
      const dataUrl=c.toDataURL('image/jpeg', quality);
      const base64=dataUrl.split(',')[1];
      resolve({ base64, approxBytes: Math.floor(base64.length*0.75), dataUrl });
    };
    img.onerror=reject;
    fr.readAsDataURL(file);
  });
}

/* ------------ State ------------ */
let offset=0, limit=20, query='', mode='create'; // or 'edit'
let currentSlug=null;
let stagedBase64=null;

/* ------------ Login flow ------------ */
async function tryLogin(){
  const key=$('#adminKey').value.trim();
  if(!key){ $('#loginMsg').textContent='Enter your admin key'; return; }
  localStorage.setItem('ADMIN_KEY', key);
  // probe the API
  try{
    await API.list('',0,1);
    $('#loginView').style.display='none';
    $('#appView').style.display='block';
    await load();
  }catch(e){
    localStorage.removeItem('ADMIN_KEY');
    $('#loginMsg').textContent='Invalid key';
  }
}
$('#loginBtn').addEventListener('click', tryLogin);
$('#adminKey').addEventListener('keydown', e=>{ if(e.key==='Enter') tryLogin(); });
(function bootstrapLogin(){
  const k=localStorage.getItem('ADMIN_KEY');
  if(k){ $('#adminKey').value=k; tryLogin(); }
})();

/* ------------ Dashboard ------------ */
async function load(){
  const rows = await API.list(query, offset, limit);
  const tbody = $('#tbl tbody');
  tbody.innerHTML='';

  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const cardUrl=`/card/${r.slug}`;
    const vcfUrl=`/.netlify/functions/vcf?slug=${r.slug}`;
    tr.innerHTML = `
      <td>${r.name||''}</td>
      <td>${r.company||''}</td>
      <td>${r.phone||''}</td>
      <td>${r.email||''}</td>
      <td>
        <a href="${cardUrl}" target="_blank">Card</a> ·
        <a href="${vcfUrl}" target="_blank">vCard</a>
      </td>
      <td>
        <button class="btn" data-act="edit">Edit</button>
        <button class="btn ghost" data-act="copy" data-url="${cardUrl}">Copy Card</button>
        <button class="btn danger" data-act="delete">Delete</button>
      </td>
    `;
    tr.querySelector('[data-act="edit"]').addEventListener('click', ()=> openEdit(r.slug));
    tr.querySelector('[data-act="delete"]').addEventListener('click', ()=> onDelete(r.slug));
    tr.querySelector('[data-act="copy"]').addEventListener('click', async (ev)=>{
      await navigator.clipboard.writeText(location.origin + ev.currentTarget.dataset.url);
      toast('Link copied');
    });
    tbody.appendChild(tr);
  });

  $('#status').textContent = `Showing ${rows.length} items (offset ${offset})`;
}

/* Search & paginate */
$('#searchBtn').addEventListener('click', ()=>{ query=$('#q').value.trim(); offset=0; load(); });
$('#clearBtn').addEventListener('click', ()=>{ $('#q').value=''; query=''; offset=0; load(); });
$('#refreshBtn').addEventListener('click', load);
$('#prevBtn').addEventListener('click', ()=>{ offset=Math.max(0,offset-limit); load(); });
$('#nextBtn').addEventListener('click', ()=>{ offset+=limit; load(); });
$('#logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('ADMIN_KEY'); location.reload(); });

/* ------------ Modal (create/edit) ------------ */
$('#newBtn').addEventListener('click', ()=> openCreate());
$('#closeModal').addEventListener('click', closeModal);
$('#logo').addEventListener('change', onLogoChange);
$('#f').addEventListener('submit', onSave);

function openCreate(){
  mode='create';
  currentSlug=null;
  stagedBase64=null;
  $('#modalTitle').textContent='Create profile';
  $('#slug').value='';
  $('#name').value=''; $('#title').value=''; $('#company').value='';
  $('#phone').value=''; $('#email').value=''; $('#website').value='';
  $('#address').value=''; $('#logo').value='';
  $('#preview').src=''; $('#previewHint').textContent='No image';
  $('#deleteBtn').style.display='none';
  $('#msg').textContent='';
  showModal();
}

async function openEdit(slug){
  mode='edit';
  currentSlug=slug; stagedBase64=null;
  $('#modalTitle').textContent='Edit profile';
  $('#deleteBtn').style.display='inline-block'; $('#msg').textContent='';
  const p = await API.get(slug);
  $('#slug').value = slug;
  $('#name').value = p.name||'';
  $('#title').value = p.title||'';
  $('#company').value = p.company||'';
  $('#phone').value = p.phone||'';
  $('#email').value = p.email||'';
  $('#website').value = p.website||'';
  $('#address').value = p.address||'';
  if (p.logo_base64){
    $('#preview').src = 'data:image/jpeg;base64,' + p.logo_base64;
    $('#previewHint').textContent = 'Existing image';
  } else {
    $('#preview').src = ''; $('#previewHint').textContent='No image';
  }
  showModal();
}

function showModal(){ $('#modalBackdrop').style.display='flex'; }
function closeModal(){ $('#modalBackdrop').style.display='none'; }

/* logo change */
async function onLogoChange(e){
  const f=e.target.files?.[0]; if(!f){ stagedBase64=null; return; }
  const beforeKB = Math.round(f.size/1024);
  const { base64, approxBytes, dataUrl } = await compressToBase64(f, 900, 0.85);
  stagedBase64 = base64;
  $('#preview').src = dataUrl;
  $('#previewHint').textContent = `Compressed ${beforeKB} KB → ~${Math.round(approxBytes/1024)} KB`;
  if (approxBytes > 1_000_000){ alert('Logo still too big after compression. Choose a smaller image.'); stagedBase64=null; $('#logo').value=''; }
}

/* helper: remove empty fields so we don't send an empty SET to SQL */
function cleanedPayload(obj){
  const out = {};
  for (const [k,v] of Object.entries(obj)){
    if (k === 'logo_base64'){ if (v) out[k]=v; continue; }
    if (v !== '' && v !== null && v !== undefined) out[k] = v;
  }
  return out;
}

/* Save (create or edit) */
async function onSave(e){
  e.preventDefault();
  const msg=$('#msg'); msg.textContent='';
  const raw = {
    name: $('#name').value.trim(),
    title: $('#title').value.trim(),
    company: $('#company').value.trim(),
    phone: normalizePhone($('#phone').value.trim()),
    email: $('#email').value.trim(),
    website: $('#website').value.trim(),
    address: $('#address').value.trim()
  };
  if (stagedBase64) raw.logo_base64 = stagedBase64;

  const payload = cleanedPayload(raw);

  try{
    if (mode==='create'){
      if (!payload.name || (!payload.phone && !payload.email)) { msg.textContent='Name and (phone or email) are required'; return; }
      const out = await API.create(payload);
      if (!out.ok) throw new Error(out.error||'Create failed');
      toast('Created'); closeModal(); load();
    } else {
      const slug = $('#slug').value;
      if (Object.keys(payload).length === 0){ msg.textContent = 'Nothing to update.'; return; }
      const out = await API.update(slug, payload);
      if (out.error) throw new Error(out.error);
      toast('Saved'); closeModal(); load();
    }
  }catch(err){
    msg.textContent = String(err?.message || err);
  }
}

/* Delete */
async function onDelete(slug){
  if(!confirm('Delete this profile?')) return;
  try{
    const out = await API.del(slug);
    if (out.error) throw new Error(out.error);
    toast('Deleted');
    closeModal(); load();
  }catch(err){
    toast('Error: ' + String(err?.message || err));
  }
}
</script>
</body>
</html>
