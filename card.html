<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Card</title>
  <style>
    body{margin:0;background:#e6f0ec;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Arial}
    .phone{width:min(420px,92vw);margin:4vh auto;background:#fff;border-radius:28px;box-shadow:0 20px 70px rgba(0,0,0,.16);overflow:hidden}
    .hero{background:#111;height:200px;display:grid;place-items:center}
    .logo{width:140px;height:140px;border-radius:50%;background:#fff;display:grid;place-items:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:cover}
    .content{padding:22px 24px}
    h1{font-size:28px;margin:12px 0 4px}
    .muted{opacity:.75;margin:0 0 10px}

    /* rows list */
    .list{display:grid;gap:18px;margin:18px 0 34px}

    /* make the whole row a link */
    .item{
      display:grid;
      grid-template-columns:56px 1fr;
      gap:14px;
      align-items:center;
      color:#000;
      text-decoration:none;     /* no underline by default */
    }
    .item:hover{opacity:.9}

    .ico{
      width:56px;height:56px;
      border-radius:50%;
      background:#111;
      display:grid;place-items:center;
    }
    .ico svg{width:26px;height:26px;fill:#fff}

    /* only Maps text shows underline */
    #mapLinkText{text-decoration:underline}

    .bar{background:#111;color:#fff;padding:16px 22px;text-align:center;font-size:17px}
    .bar a{color:#fff;text-decoration:none;display:block}
  </style>
</head>
<body>
  <div class="phone">
    <div class="hero"><div class="logo"><img id="logo" alt=""></div></div>

    <div class="content" id="card">
      <h1 id="name">—</h1>
      <div class="muted" id="title"></div>
      <div class="muted" id="org"></div>

      <div class="list">
        <!-- Phone (whole row clickable) -->
        <a class="item" id="telRow" style="display:none">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62 10.79a15.46 15.46 0 006.59 6.59l2.2-2.2a1 1 0 01.91-.27c1 .23 2.07.35 3.18.35a1 1 0 011 1V20a1 1 0 01-1 1C10.07 21 3 13.93 3 5a1 1 0 011-1h3.5a1 1 0 011 1c0 1.11.12 2.18.35 3.18a1 1 0 01-.27.91l-2.2 2.2z"/></svg>
          </div>
          <span id="telLink"></span>
        </a>

        <!-- Email (whole row clickable) -->
        <a class="item" id="emailRow" style="display:none">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          </div>
          <span id="emailLink"></span>
        </a>

        <!-- Website (whole row clickable) -->
        <a class="item" id="webRow" style="display:none" target="_blank" rel="noopener">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm5 10h-2a8 8 0 01-8 8c0-4.42 3.58-8 8-8zM12 4c1.85 0 3.55.63 4.9 1.69A7.963 7.963 0 0012 12H4a8 8 0 018-8z"/></svg>
          </div>
          <span id="webLink"></span>
        </a>

        <!-- Address (whole row clickable to Maps; only "Open in Maps" text underlined) -->
        <a class="item" id="adrRow" style="display:none" target="_blank" rel="noopener">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5A2.5 2.5 0 1114.5 9 2.5 2.5 0 0112 11.5z"/></svg>
          </div>
          <span>
            <span id="adrText"></span><br>
            <span id="mapLinkText">Open in Maps</span>
          </span>
        </a>
      </div>
    </div>

    <div class="bar"><a id="saveBtn" href="#">Save contact</a></div>
  </div>

  <script>
    (async () => {
      const byId = id => document.getElementById(id);
      const container = byId('card') || document.body;

      // slug from /card/<slug> or ?slug=
      const pathMatch = location.pathname.match(/\/card\/([^\/?#]+)/);
      const slug = (pathMatch && pathMatch[1]) || new URLSearchParams(location.search).get('slug');
      if (!slug) { container.innerHTML = 'Card not found (missing slug)'; return; }

      const r = await fetch('/.netlify/functions/get_profile?slug=' + encodeURIComponent(slug));
      if (!r.ok) { container.innerHTML = 'Card not found'; return; }
      const p = await r.json();

      // Header
      byId('name').textContent  = p.name || '';
      byId('title').textContent = p.title || '';
      byId('org').textContent   = p.company || '';
      if (p.logo_base64) byId('logo').src = 'data:image/jpeg;base64,' + p.logo_base64;

      // Phone
      if (p.phone) {
        const row = byId('telRow');
        row.style.display = 'grid';
        row.href = 'tel:' + p.phone;
        byId('telLink').textContent = p.phone;
      }

      // Email
      if (p.email) {
        const row = byId('emailRow');
        row.style.display = 'grid';
        row.href = 'mailto:' + p.email;
        byId('emailLink').textContent = p.email;
      }

      // Website
      if (p.website) {
        const row = byId('webRow');
        row.style.display = 'grid';
        const url = p.website.startsWith('http') ? p.website : ('https://' + p.website);
        row.href = url;
        byId('webLink').textContent = p.website.replace(/^https?:\/\/(www\.)?/,'');
      }

      // Address → open in maps
      if (p.address) {
        const row = byId('adrRow');
        row.style.display = 'grid';
        byId('adrText').textContent = p.address;
        row.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(p.address);
      }

      // Save contact button
      byId('saveBtn').addEventListener('click', (e) => {
        e.preventDefault();
        location.href = '/.netlify/functions/vcf?slug=' + encodeURIComponent(slug);
      });
    })();
  </script>
</body>
</html>
