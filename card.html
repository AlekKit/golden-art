<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Card</title>
  <style>
    body{margin:0;background:#e6f0ec;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Arial}
    .phone{width:min(420px,92vw);margin:4vh auto;background:#fff;border-radius:28px;box-shadow:0 20px 70px rgba(0,0,0,.16);overflow:hidden;position:relative}

    /* Loader */
    #loader{
      display:grid;place-items:center;height:100vh;
      font-size:20px;color:#111;font-weight:500;
    }

    /* hero / logo */
    .hero{background:#111;height:200px;display:grid;place-items:center;position:relative}
    .logo{width:140px;height:140px;border-radius:50%;background:#fff;display:grid;place-items:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:cover}

    /* share button (top-right) */
    .share-btn{
      position:absolute;top:14px;right:14px;
      width:42px;height:42px;border-radius:50%;
      background:#fff;border:0;box-shadow:0 6px 18px rgba(0,0,0,.18);
      display:grid;place-items:center;cursor:pointer;
    }
    .share-btn:active{transform:translateY(1px)}
    .share-btn svg{width:20px;height:20px;fill:#111}

    .content{padding:22px 24px}
    h1{font-size:28px;margin:12px 0 4px}
    .muted{opacity:.75;margin:0 0 10px}

    /* rows list */
    .list{display:grid;gap:18px;margin:18px 0 34px}
    .item{
      display:grid;grid-template-columns:56px 1fr;gap:14px;align-items:center;
      color:#000;text-decoration:none
    }
    .item:hover{opacity:.9}
    .ico{width:56px;height:56px;border-radius:50%;background:#111;display:grid;place-items:center}
    .ico svg{width:26px;height:26px;fill:#fff}
    #mapLinkText{text-decoration:underline}

    .bar{background:#111;color:#fff;padding:16px 22px;text-align:center;font-size:17px}
    .bar a{color:#fff;text-decoration:none;display:block}

    /* ===== Share Modal ===== */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;z-index:50;
    }
    .modal{width:min(520px,92vw);background:#fff;border-radius:16px;box-shadow:0 24px 80px rgba(0,0,0,.28);overflow:hidden}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(0,0,0,.08)}
    .modal header h3{margin:0;font-size:18px}
    .close-x{border:0;background:transparent;font-size:22px;cursor:pointer;line-height:1}
    .modal .body{padding:8px 18px 18px;display:grid;gap:10px}

    .share-item{display:flex;align-items:center;gap:12px;padding:10px 8px;border-radius:10px;cursor:pointer;text-decoration:none;color:#111}
    .share-item:hover{background:rgba(0,0,0,.04)}
    .s-ico{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;color:#fff;font-size:16px}
    .wa{background:#25D366}.ml{background:#666}.li{background:#0A66C2}.fb{background:#1877F2}
    .sms{background:#111}.x{background:#000}

    .link-row{display:flex;gap:8px;margin-top:6px}
    .link-row input{flex:1;padding:10px 12px;border:1px solid #d6dde3;border-radius:10px;background:#f7f9fb}
    .copy-btn{padding:10px 12px;border:1px solid #d6dde3;border-radius:10px;background:#fff;cursor:pointer}
    .cta-footer{padding:14px 18px;border-top:1px solid rgba(0,0,0,.08);display:flex;justify-content:center}
    .cta-footer a{display:inline-block;background:#111;color:#fff;text-decoration:none;padding:12px 16px;border-radius:12px}
  </style>
</head>
<body>

  <!-- Preloader -->
  <div id="loader">Loading card...</div>

  <div class="phone" id="cardContainer" style="display:none">
    <div class="hero">
      <div class="logo"><img id="logo" alt=""></div>
      <!-- Share button -->
      <button class="share-btn" id="openShare" aria-label="Share">
        <!-- paper-airplane icon -->
        <svg viewBox="0 0 24 24"><path d="M21.44 2.56a1 1 0 0 0-1.03-.2L2.6 9.24a1 1 0 0 0 .07 1.88l7.32 2.2 2.2 7.32a1 1 0 0 0 1.88.07l6.88-17.81a1 1 0 0 0-.51-1.34ZM12.9 19.2l-1.6-5.33 5.33-5.33-3.73 9.9ZM10.13 12.7 4.8 11.1l9.9-3.73-4.57 5.33Z"/></svg>
      </button>
    </div>

    <div class="content" id="card">
      <h1 id="name">‚Äî</h1>
      <div class="muted" id="title"></div>
      <div class="muted" id="org"></div>

      <div class="list">
        <!-- Phone (whole row clickable) -->
        <a class="item" id="telRow" style="display:none">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.62 10.79a15.46 15.46 0 006.59 6.59l2.2-2.2a1 1 0 01.91-.27c1 .23 2.07.35 3.18.35a1 1 0 011 1V20a1 1 0 01-1 1C10.07 21 3 13.93 3 5a1 1 0 011-1h3.5a1 1 0 011 1c0 1.11.12 2.18.35 3.18a1 1 0 01-.27.91l-2.2 2.2z"/></svg>
          </div>
          <span id="telLink"></span>
        </a>

        <!-- Email (whole row clickable) -->
        <a class="item" id="emailRow" style="display:none">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
          </div>
          <span id="emailLink"></span>
        </a>

        <!-- Website (whole row clickable) -->
        <a class="item" id="webRow" style="display:none" target="_blank" rel="noopener">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm5 10h-2a8 8 0 01-8 8c0-4.42 3.58-8 8-8zM12 4c1.85 0 3.55.63 4.9 1.69A7.963 7.963 0 0012 12H4a8 8 0 018-8z"/></svg>
          </div>
          <span id="webLink"></span>
        </a>

        <!-- Address (whole row clickable to Maps; only "Open in Maps" text underlined) -->
        <a class="item" id="adrRow" style="display:none" target="_blank" rel="noopener">
          <div class="ico">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5A2.5 2.5 0 1114.5 9 2.5 2.5 0 0112 11.5z"/></svg>
          </div>
          <span>
            <span id="adrText"></span><br>
            <span id="mapLinkText">Open in Maps</span>
          </span>
        </a>
      </div>
    </div>

    <div class="bar"><a id="saveBtn" href="#">Save contact</a></div>
  </div>

  <!-- ===== Share Modal Markup ===== -->
  <div class="modal-backdrop" id="shareModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
      <header>
        <h3 id="shareTitle">Share your contact</h3>
        <button class="close-x" id="closeShare" aria-label="Close">√ó</button>
      </header>
      <div class="body">
        <a class="share-item" id="shareWa" target="_blank" rel="noopener">
          <span class="s-ico wa">WA</span> <span>Share on WhatsApp</span>
        </a>
        <a class="share-item" id="shareMail">
          <span class="s-ico ml">‚úâ</span> <span>Share by Email</span>
        </a>
        <a class="share-item" id="shareLi" target="_blank" rel="noopener">
          <span class="s-ico li">in</span> <span>Share on LinkedIn</span>
        </a>
        <a class="share-item" id="shareFb" target="_blank" rel="noopener">
          <span class="s-ico fb">f</span> <span>Share on Facebook</span>
        </a>
        <a class="share-item" id="shareSms">
          <span class="s-ico sms">SMS</span> <span>Share by SMS</span>
        </a>
        <a class="share-item" id="shareX" target="_blank" rel="noopener">
          <span class="s-ico x">ùïè</span> <span>Share on X</span>
        </a>

        <div class="link-row">
          <input id="shareLink" readonly>
          <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      const byId = id => document.getElementById(id);
      const loader = byId('loader');
      const cardWrap = byId('cardContainer');
      const container = byId('card') || document.body;

      // slug from /card/<slug> or ?slug=
      const pathMatch = location.pathname.match(/\/card\/([^\/?#]+)/);
      const slug = (pathMatch && pathMatch[1]) || new URLSearchParams(location.search).get('slug');
      if (!slug) { loader.textContent = 'Card not found (missing slug)'; return; }

      try {
        const r = await fetch('/.netlify/functions/get_profile?slug=' + encodeURIComponent(slug));
        if (!r.ok) { loader.textContent = 'Card not found'; return; }
        const p = await r.json();

        // Header
        byId('name').textContent  = p.name || '';
        byId('title').textContent = p.title || '';
        byId('org').textContent   = p.company || '';
        if (p.logo_base64) byId('logo').src = 'data:image/jpeg;base64,' + p.logo_base64;

        // Phone
        if (p.phone) {
          const row = byId('telRow');
          row.style.display = 'grid';
          row.href = 'tel:' + p.phone;
          byId('telLink').textContent = p.phone;
        }

        // Email
        if (p.email) {
          const row = byId('emailRow');
          row.style.display = 'grid';
          row.href = 'mailto:' + p.email;
          byId('emailLink').textContent = p.email;
        }

        // Website
        if (p.website) {
          const row = byId('webRow');
          row.style.display = 'grid';
          const url = p.website.startsWith('http') ? p.website : ('https://' + p.website);
          row.href = url;
          byId('webLink').textContent = p.website.replace(/^https?:\/\/(www\.)?/, '');
        }

        // Address ‚Üí open in maps
        if (p.address) {
          const row = byId('adrRow');
          row.style.display = 'grid';
          byId('adrText').textContent = p.address;
          row.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(p.address);
        }

        // Save contact button
        byId('saveBtn').addEventListener('click', (e) => {
          e.preventDefault();
          location.href = '/.netlify/functions/vcf?slug=' + encodeURIComponent(slug);
        });

        // ===== Share logic (non-intrusive) =====
        const shareUrl = location.origin + '/card/' + slug;
        const text = encodeURIComponent('My contact card: ' + shareUrl);

        byId('shareLink').value = shareUrl;
        byId('shareWa').href = 'https://wa.me/?text=' + text;
        byId('shareLi').href = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(shareUrl);
        byId('shareFb').href = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl);
        byId('shareX').href  = 'https://twitter.com/intent/tweet?text=' + text;

        byId('shareMail').addEventListener('click', () => {
          const subj = encodeURIComponent('My contact card');
          const body = encodeURIComponent('Here is my contact card:\n\n' + shareUrl);
          location.href = 'mailto:?subject=' + subj + '&body=' + body;
        });
        byId('shareSms').addEventListener('click', () => {
          const body = encodeURIComponent('My contact card: ' + shareUrl);
          location.href = 'sms:?&body=' + body;
        });

        byId('copyBtn').addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(shareUrl);
            byId('copyBtn').textContent = 'Copied!';
            setTimeout(() => byId('copyBtn').textContent = 'Copy', 1200);
          } catch { /* ignore */ }
        });

        const modal = byId('shareModal');
        byId('openShare').addEventListener('click', () => modal.style.display = 'flex');
        byId('closeShare').addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

        // Success: show card, hide loader
        loader.style.display = 'none';
        cardWrap.style.display = 'block';

      } catch (err) {
        loader.textContent = 'Could not load card.';
      }
    })();
  </script>
</body>
</html>
