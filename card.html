<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Card</title>
  <style>
    body{margin:0;background:#e6f0ec;font-family:ui-sans-serif,-apple-system,system-ui,Segoe UI,Arial}
    .phone{width:min(420px,92vw);margin:4vh auto;background:#fff;border-radius:28px;box-shadow:0 20px 70px rgba(0,0,0,.16);overflow:hidden}
    .hero{background:#111;height:200px;display:grid;place-items:center}
    .logo{width:140px;height:140px;border-radius:50%;background:#fff;display:grid;place-items:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:cover}
    .content{padding:22px 24px}
    h1{font-size:28px;margin:12px 0 4px}
    .muted{opacity:.75;margin:0 0 10px}
    .list{display:grid;gap:18px;margin:18px 0 34px}
    .item{display:grid;grid-template-columns:56px 1fr;gap:14px;align-items:center}
    .ico{width:56px;height:56px;border-radius:50%;background:#111;color:#fff;display:grid;place-items:center;font-size:24px}
    .bar{background:#111;color:#fff;padding:16px 22px;text-align:center;font-size:17px}
    .bar a{color:#fff;text-decoration:none;display:block}
  </style>
</head>
<body>
  <div class="phone">
    <div class="hero"><div class="logo"><img id="logo" alt=""></div></div>
    <div class="content" id="card">
      <h1 id="name">‚Äî</h1>
      <div class="muted" id="title"></div>
      <div class="muted" id="org"></div>
      <div class="list">
        <div class="item" id="telRow" style="display:none"><div class="ico">üìû</div><a id="telLink"></a></div>
        <div class="item" id="emailRow" style="display:none"><div class="ico">‚úâÔ∏è</div><a id="emailLink"></a></div>
        <div class="item" id="webRow" style="display:none"><div class="ico">üîó</div><a id="webLink" target="_blank" rel="noopener"></a></div>
        <div class="item" id="adrRow" style="display:none"><div class="ico">üìç</div><div><span id="adrText"></span><br><a id="mapLink" target="_blank" rel="noopener">Open in Maps</a></div></div>
      </div>
    </div>
    <div class="bar"><a id="saveBtn" href="#">Save contact</a></div>
  </div>

  <script>
    (async () => {
      const byId = id => document.getElementById(id);
      const container = byId('card') || document.body;

      // Extract slug from /card/<slug> (fallback to ?slug=)
      const pathMatch = location.pathname.match(/\/card\/([^\/?#]+)/);
      const slug = (pathMatch && pathMatch[1]) || new URLSearchParams(location.search).get('slug');

      if (!slug) { container.innerHTML = 'Card not found (missing slug)'; return; }

      // Fetch profile
      const r = await fetch('/.netlify/functions/get_profile?slug=' + encodeURIComponent(slug));
      if (!r.ok) { container.innerHTML = 'Card not found'; return; }
      const p = await r.json();

      // Render
      byId('name').textContent  = p.name || '';
      byId('title').textContent = p.title || '';
      byId('org').textContent   = p.company || '';

      if (p.phone) {
        byId('telRow').style.display = 'grid';
        byId('telLink').textContent = p.phone;
        byId('telLink').href = 'tel:' + p.phone;
      }
      if (p.email) {
        byId('emailRow').style.display = 'grid';
        byId('emailLink').textContent = p.email;
        byId('emailLink').href = 'mailto:' + p.email;
      }
      if (p.website) {
        byId('webRow').style.display = 'grid';
        const clean = p.website.replace(/^https?:\/\/(www\.)?/,'');
        byId('webLink').textContent = clean;
        byId('webLink').href = p.website.startsWith('http') ? p.website : ('https://' + p.website);
      }
      if (p.address) {
        byId('adrRow').style.display = 'grid';
        byId('adrText').textContent = p.address;
        byId('mapLink').href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(p.address);
      }
      if (p.logo_base64) {
        byId('logo').src = 'data:image/jpeg;base64,' + p.logo_base64; // critical prefix
      }

      // Save contact
      byId('saveBtn').addEventListener('click', (e) => {
        e.preventDefault();
        location.href = '/.netlify/functions/vcf?slug=' + encodeURIComponent(slug);
      });
    })();
  </script>
</body>
</html>
